name: Frontend CI/CD - Build, Versionamento e Imagem Docker

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build_version_docker:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout do Código
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 

      - name: Instalar Dependências do Frontend
        run: npm install

      - name: Rodar Lint
        run: npm run lint
        
      - name: Buildar Frontend
        run: npm run build 

      - name: Exibir Conteúdo da Pasta Dist (para depuração)
        run: |
          echo "Conteúdo da pasta dist (após o build):"
          ls -l dist
          echo "Listando todos os arquivos dentro de dist (recursivamente):"
          find dist -type f

      - name: Configurar Credenciais do Git (para push de tag)
        run: |
          git config user.name "ADACompany01"
          git config user.email "ada2024fatec.mrs@outlook.com"

      - name: Executar Lógica de Versionamento e Criar Tag/Commit
        id: versioning
        run: |
          git fetch origin --tags # Buscar todas as tags existentes do repositório

          # Tentar pegar a última versão existente, se não houver, começa de v0.0.0
          LATEST_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Última versão encontrada para o Frontend: $LATEST_VERSION"

          # Extrair major, minor, patch da versão atual
          # Remover 'v' do prefixo para manipulação de versão
          VERSION_WITHOUT_V=$(echo $LATEST_VERSION | sed 's/^v//')
          
          # Verificar se a string não está vazia antes de cortar
          if [ -z "$VERSION_WITHOUT_V" ]; then
              CURRENT_MAJOR=0
              CURRENT_MINOR=0
              CURRENT_PATCH=0
          else
              CURRENT_MAJOR=$(echo $VERSION_WITHOUT_V | cut -d. -f1)
              CURRENT_MINOR=$(echo $VERSION_WITHOUT_V | cut -d. -f2)
              CURRENT_PATCH=$(echo $VERSION_WITHOUT_V | cut -d. -f3)
          fi

          # Incrementar a versão PATCH
          NEW_PATCH=$((CURRENT_PATCH + 1))
          NEW_VERSION="v${CURRENT_MAJOR}.${CURRENT_MINOR}.${NEW_PATCH}"

          echo "Nova versão proposta para o Frontend: $NEW_VERSION"

          # Criar a nova tag
          git tag "$NEW_VERSION"

          # Empurrar a nova tag para o repositório remoto
          git push origin "$NEW_VERSION"

          # Salvar a nova versão como uma saída do passo para ser usada por outros passos
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Fazer Login no Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Buildar e Publicar Imagem Docker do Frontend
        uses: docker/build-push-action@v5
        with:
          context: . 
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ada-company-frontend:${{ steps.versioning.outputs.new_version }},${{ secrets.DOCKER_USERNAME }}/ada-company-frontend:latest
